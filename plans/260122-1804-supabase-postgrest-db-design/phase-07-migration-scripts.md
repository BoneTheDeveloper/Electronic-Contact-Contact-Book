# Phase 07 - Migration Scripts & TypeScript Types

**Date**: 2026-01-22 | **Priority**: High | **Status**: Draft

## Overview

Supabase migration scripts and TypeScript type generation for frontend apps.

## Migration File Structure

```
supabase/
├── migrations/
│   ├── 20260122000001_initial_schema.sql
│   ├── 20260122000002_core_data.sql
│   ├── 20260122000003_academic_data.sql
│   ├── 20260122000004_finance_data.sql
│   ├── 20260122000005_communications.sql
│   └── 20260122000006_rls_policies.sql
└── types/
    └── database.types.ts  -- Generated by Supabase CLI
```

## Migration Scripts

### 1. Initial Schema

**File**: `supabase/migrations/20260122000001_initial_schema.sql`

```sql
-- Enable necessary extensions
CREATE EXTENSION IF NOT EXISTS "uuid-ossp";
CREATE EXTENSION IF NOT EXISTS "pgcrypto";

-- Create custom types
CREATE TYPE user_role AS ENUM ('admin', 'teacher', 'parent', 'student');
CREATE TYPE account_status AS ENUM ('active', 'inactive');
CREATE TYPE attendance_status AS ENUM ('present', 'absent', 'late', 'excused');
CREATE TYPE grade_type AS ENUM ('oral', 'quiz', 'midterm', 'final');
CREATE TYPE assessment_type AS ENUM ('quiz', 'midterm', 'final', 'oral');
CREATE TYPE assignment_type AS ENUM ('homeroom', 'subject');
CREATE TYPE invoice_status AS ENUM ('pending', 'partial', 'paid', 'overdue', 'cancelled');
CREATE TYPE leave_status AS ENUM ('pending', 'approved', 'rejected');
CREATE TYPE notification_type AS ENUM ('info', 'warning', 'success', 'error');
CREATE TYPE fee_type_enum AS ENUM ('mandatory', 'voluntary');
CREATE TYPE payment_method AS ENUM ('cash', 'bank_transfer', 'qr_code', 'card', 'other');

-- Helper: updated_at trigger
CREATE OR REPLACE FUNCTION update_updated_at()
RETURNS TRIGGER AS $$
BEGIN
  NEW.updated_at = NOW();
  RETURN NEW;
END;
$$ LANGUAGE plpgsql;

-- Helper: current user role
CREATE OR REPLACE FUNCTION current_user_role()
RETURNS user_role AS $$
  SELECT role FROM profiles WHERE id = auth.uid();
$$ LANGUAGE SQL STABLE SECURITY DEFINER;

-- Helper: is admin
CREATE OR REPLACE FUNCTION is_admin()
RETURNS BOOLEAN AS $$
  SELECT EXISTS (SELECT 1 FROM profiles WHERE id = auth.uid() AND role = 'admin'::user_role);
$$ LANGUAGE SQL STABLE SECURITY DEFINER;
```

### 2. Core Auth Tables

**File**: `supabase/migrations/20260122000002_core_tables.sql`

```sql
-- Profiles (extends auth.users)
CREATE TABLE profiles (
  id UUID PRIMARY KEY REFERENCES auth.users(id) ON DELETE CASCADE,
  email TEXT NOT NULL,
  role user_role NOT NULL,
  full_name TEXT,
  phone TEXT,
  avatar_url TEXT,
  status account_status DEFAULT 'active',
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- Students
CREATE TABLE students (
  id UUID PRIMARY KEY REFERENCES profiles(id) ON DELETE CASCADE,
  student_code TEXT UNIQUE NOT NULL,
  date_of_birth DATE,
  gender TEXT CHECK (gender IN ('male', 'female')),
  address TEXT,
  enrollment_date DATE DEFAULT CURRENT_DATE,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- Teachers
CREATE TABLE teachers (
  id UUID PRIMARY KEY REFERENCES profiles(id) ON DELETE CASCADE,
  employee_code TEXT UNIQUE NOT NULL,
  subject TEXT,
  join_date DATE DEFAULT CURRENT_DATE,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- Parents
CREATE TABLE parents (
  id UUID PRIMARY KEY REFERENCES profiles(id) ON DELETE CASCADE,
  relationship TEXT DEFAULT 'parent',
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- Student-Parent relationships
CREATE TABLE student_guardians (
  student_id UUID NOT NULL REFERENCES students(id) ON DELETE CASCADE,
  guardian_id UUID NOT NULL REFERENCES parents(id) ON DELETE CASCADE,
  is_primary BOOLEAN DEFAULT false,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  PRIMARY KEY (student_id, guardian_id)
);

CREATE INDEX idx_student_guardians_student ON student_guardians(student_id);
CREATE INDEX idx_student_guardians_guardian ON student_guardians(guardian_id);

-- Auto-create profile on signup
CREATE OR REPLACE FUNCTION public.handle_new_user()
RETURNS TRIGGER AS $$
BEGIN
  INSERT INTO public.profiles (id, email, role, full_name)
  VALUES (
    NEW.id,
    NEW.email,
    COALESCE((NEW.raw_user_meta_data->>'role')::user_role, 'student'::user_role),
    COALESCE(NEW.raw_user_meta_data->>'full_name', split_part(NEW.email, '@', 1))
  );
  RETURN NEW;
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;

CREATE TRIGGER on_auth_user_created
  AFTER INSERT ON auth.users
  FOR EACH ROW EXECUTE FUNCTION public.handle_new_user();

-- Enable RLS
ALTER TABLE profiles ENABLE ROW LEVEL SECURITY;
ALTER TABLE students ENABLE ROW LEVEL SECURITY;
ALTER TABLE teachers ENABLE ROW LEVEL SECURITY;
ALTER TABLE parents ENABLE ROW LEVEL SECURITY;
ALTER TABLE student_guardians ENABLE ROW LEVEL SECURITY;
```

### 3. Academic Tables

**File**: `supabase/migrations/20260122000003_academic_tables.sql`

```sql
-- Grades
CREATE TABLE grades (
  id TEXT PRIMARY KEY CHECK (id IN ('6', '7', '8', '9')),
  name TEXT NOT NULL UNIQUE,
  display_order INT DEFAULT 6
);

-- Classes
CREATE TABLE classes (
  id TEXT PRIMARY KEY,
  name TEXT NOT NULL,
  grade_id TEXT REFERENCES grades(id) ON DELETE RESTRICT,
  room TEXT,
  capacity INT DEFAULT 40,
  homeroom_teacher_id UUID REFERENCES teachers(id),
  school_year TEXT DEFAULT '2024-2025',
  status account_status DEFAULT 'active',
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW(),
  CONSTRAINT valid_class_id CHECK (id ~ '^[6-9][A-Z]$')
);

-- Subjects
CREATE TABLE subjects (
  id TEXT PRIMARY KEY,
  name TEXT NOT NULL UNIQUE,
  name_en TEXT,
  code TEXT UNIQUE NOT NULL,
  is_core BOOLEAN DEFAULT false,
  display_order INT DEFAULT 0
);

-- Enrollments
CREATE TABLE enrollments (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  student_id UUID NOT NULL REFERENCES students(id) ON DELETE CASCADE,
  class_id TEXT NOT NULL REFERENCES classes(id) ON DELETE CASCADE,
  school_year TEXT DEFAULT '2024-2025',
  semester TEXT CHECK (semester IN ('1', '2', 'all')) DEFAULT 'all',
  status account_status DEFAULT 'active',
  enrollment_date DATE DEFAULT CURRENT_DATE,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW(),
  UNIQUE(student_id, class_id, school_year)
);

-- Teacher Assignments
CREATE TABLE teacher_assignments (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  teacher_id UUID NOT NULL REFERENCES teachers(id) ON DELETE CASCADE,
  class_id TEXT NOT NULL REFERENCES classes(id) ON DELETE CASCADE,
  subject_id TEXT REFERENCES subjects(id) ON DELETE SET NULL,
  assignment_type assignment_type NOT NULL,
  school_year TEXT DEFAULT '2024-2025',
  created_at TIMESTAMPTZ DEFAULT NOW(),
  CONSTRAINT unique_homeroom UNIQUE (class_id, school_year, assignment_type)
    WHERE assignment_type = 'homeroom'
);

-- Schedule Templates
CREATE TABLE schedule_templates (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  class_id TEXT NOT NULL REFERENCES classes(id) ON DELETE CASCADE,
  subject_id TEXT NOT NULL REFERENCES subjects(id) ON DELETE CASCADE,
  teacher_id UUID NOT NULL REFERENCES teachers(id) ON DELETE CASCADE,
  day_of_week INT CHECK (day_of_week BETWEEN 2 AND 7),
  period_start INT CHECK (period_start BETWEEN 1 AND 10),
  period_end INT CHECK (period_end BETWEEN 1 AND 10),
  room TEXT,
  school_year TEXT DEFAULT '2024-2025',
  semester TEXT CHECK (semester IN ('1', '2', 'all')) DEFAULT 'all',
  created_at TIMESTAMPTZ DEFAULT NOW(),
  CONSTRAINT valid_period_range CHECK (period_end >= period_start)
);

-- Periods
CREATE TABLE periods (
  id INT PRIMARY KEY CHECK (id BETWEEN 1 AND 10),
  name TEXT NOT NULL,
  start_time TIME NOT NULL,
  end_time TIME NOT NULL,
  is_break BOOLEAN DEFAULT false,
  display_order INT DEFAULT id
);

-- Attendance
CREATE TABLE attendance (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  student_id UUID NOT NULL REFERENCES students(id) ON DELETE CASCADE,
  class_id TEXT NOT NULL REFERENCES classes(id) ON DELETE CASCADE,
  attendance_date DATE NOT NULL,
  status attendance_status NOT NULL,
  note TEXT,
  recorded_by UUID REFERENCES teachers(id),
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW(),
  UNIQUE(student_id, attendance_date)
);

-- Grade Entries
CREATE TABLE grade_entries (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  student_id UUID NOT NULL REFERENCES students(id) ON DELETE CASCADE,
  class_id TEXT NOT NULL REFERENCES classes(id) ON DELETE CASCADE,
  subject_id TEXT NOT NULL REFERENCES subjects(id) ON DELETE CASCADE,
  semester TEXT CHECK (semester IN ('1', '2')) NOT NULL,
  school_year TEXT DEFAULT '2024-2025',
  grade_type grade_type NOT NULL,
  sequence_num INT,
  score DECIMAL(3,1) CHECK (score BETWEEN 0 AND 10),
  max_score DECIMAL(3,1) DEFAULT 10.0,
  note TEXT,
  graded_by UUID REFERENCES teachers(id),
  graded_at TIMESTAMPTZ DEFAULT NOW(),
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW(),
  CONSTRAINT unique_grade_entry UNIQUE (student_id, class_id, subject_id, semester, grade_type, sequence_num)
);

-- Assessments
CREATE TABLE assessments (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  class_id TEXT NOT NULL REFERENCES classes(id) ON DELETE CASCADE,
  subject_id TEXT NOT NULL REFERENCES subjects(id) ON DELETE CASCADE,
  name TEXT NOT NULL,
  assessment_type assessment_type NOT NULL,
  assessment_date DATE NOT NULL,
  max_score DECIMAL(3,1) DEFAULT 10.0,
  semester TEXT CHECK (semester IN ('1', '2')) NOT NULL,
  school_year TEXT DEFAULT '2024-2025',
  status TEXT DEFAULT 'draft' CHECK (status IN ('draft', 'published', 'graded')),
  total_students INT DEFAULT 0,
  submitted_count INT DEFAULT 0,
  graded_count INT DEFAULT 0,
  created_by UUID REFERENCES teachers(id),
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- Assessment Grades
CREATE TABLE assessment_grades (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  assessment_id UUID NOT NULL REFERENCES assessments(id) ON DELETE CASCADE,
  student_id UUID NOT NULL REFERENCES students(id) ON DELETE CASCADE,
  score DECIMAL(3,1) CHECK (score BETWEEN 0 AND 10),
  note TEXT,
  graded_by UUID REFERENCES teachers(id),
  graded_at TIMESTAMPTZ,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  UNIQUE(assessment_id, student_id)
);

-- Conduct Ratings
CREATE TABLE conduct_ratings (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  student_id UUID NOT NULL REFERENCES students(id) ON DELETE CASCADE,
  class_id TEXT NOT NULL REFERENCES classes(id) ON DELETE CASCADE,
  semester TEXT CHECK (semester IN ('1', '2')) NOT NULL,
  school_year TEXT DEFAULT '2024-2025',
  academic_rating TEXT CHECK (academic_rating IN ('excellent-plus', 'excellent', 'good', 'average', 'needs-improvement')),
  academic_score DECIMAL(3,1),
  conduct_rating TEXT CHECK (conduct_rating IN ('good', 'fair', 'average', 'poor')),
  notes TEXT,
  rated_by UUID REFERENCES teachers(id),
  rated_at TIMESTAMPTZ DEFAULT NOW(),
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW(),
  UNIQUE(student_id, class_id, semester, school_year)
);

-- Enable RLS
ALTER TABLE grades ENABLE ROW LEVEL SECURITY;
ALTER TABLE classes ENABLE ROW LEVEL SECURITY;
ALTER TABLE subjects ENABLE ROW LEVEL SECURITY;
ALTER TABLE enrollments ENABLE ROW LEVEL SECURITY;
ALTER TABLE teacher_assignments ENABLE ROW LEVEL SECURITY;
ALTER TABLE schedule_templates ENABLE ROW LEVEL SECURITY;
ALTER TABLE periods ENABLE ROW LEVEL SECURITY;
ALTER TABLE attendance ENABLE ROW LEVEL SECURITY;
ALTER TABLE grade_entries ENABLE ROW LEVEL SECURITY;
ALTER TABLE assessments ENABLE ROW LEVEL SECURITY;
ALTER TABLE assessment_grades ENABLE ROW LEVEL SECURITY;
ALTER TABLE conduct_ratings ENABLE ROW LEVEL SECURITY;
```

### 4. Finance Tables

**File**: `supabase/migrations/20260122000004_finance_tables.sql`

```sql
-- Fee Items
CREATE TABLE fee_items (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  name TEXT NOT NULL UNIQUE,
  code TEXT UNIQUE NOT NULL,
  description TEXT,
  fee_type fee_type_enum NOT NULL,
  amount DECIMAL(15,0) NOT NULL,
  semester TEXT CHECK (semester IN ('1', '2', 'all')) DEFAULT 'all',
  academic_year TEXT DEFAULT '2024-2025',
  status account_status DEFAULT 'active',
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- Fee Assignments
CREATE TABLE fee_assignments (
  id TEXT PRIMARY KEY,
  name TEXT NOT NULL,
  target_grades TEXT[],
  target_classes TEXT[],
  fee_items UUID[] NOT NULL,
  start_date DATE NOT NULL,
  due_date DATE NOT NULL,
  reminder_days INT DEFAULT 7,
  reminder_frequency TEXT CHECK (reminder_frequency IN ('once', 'daily', 'weekly')) DEFAULT 'once',
  total_students INT DEFAULT 0,
  total_amount DECIMAL(15,0) DEFAULT 0,
  collected_amount DECIMAL(15,0) DEFAULT 0,
  status TEXT DEFAULT 'draft' CHECK (status IN ('draft', 'published', 'closed')),
  created_by UUID REFERENCES teachers(id),
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW(),
  CONSTRAINT valid_dates CHECK (due_date > start_date)
);

-- Invoices
CREATE TABLE invoices (
  id TEXT PRIMARY KEY,
  invoice_number TEXT UNIQUE,
  student_id UUID NOT NULL REFERENCES students(id) ON DELETE CASCADE,
  fee_assignment_id TEXT REFERENCES fee_assignments(id) ON DELETE SET NULL,
  name TEXT NOT NULL,
  description TEXT,
  amount DECIMAL(15,0) NOT NULL,
  discount_amount DECIMAL(15,0) DEFAULT 0,
  total_amount DECIMAL(15,0) GENERATED ALWAYS AS (amount - discount_amount) STORED,
  issue_date DATE DEFAULT CURRENT_DATE,
  due_date DATE NOT NULL,
  status invoice_status DEFAULT 'pending',
  paid_amount DECIMAL(15,0) DEFAULT 0,
  paid_date DATE,
  payment_method payment_method,
  transaction_ref TEXT,
  notes TEXT,
  created_by UUID REFERENCES teachers(id),
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- Invoice Items (breakdown of fees per invoice)
CREATE TABLE invoice_items (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  invoice_id TEXT NOT NULL REFERENCES invoices(id) ON DELETE CASCADE,
  fee_item_id UUID REFERENCES fee_items(id) ON DELETE SET NULL,
  item_name TEXT NOT NULL,
  quantity INT DEFAULT 1,
  unit_price DECIMAL(15,0) NOT NULL,
  amount DECIMAL(15,0) GENERATED ALWAYS AS (quantity * unit_price) STORED,
  created_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE INDEX idx_invoice_items_invoice ON invoice_items(invoice_id);
CREATE INDEX idx_invoice_items_fee_item ON invoice_items(fee_item_id);

-- Payment Transactions
CREATE TABLE payment_transactions (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  invoice_id TEXT NOT NULL REFERENCES invoices(id) ON DELETE CASCADE,
  amount DECIMAL(15,0) NOT NULL,
  payment_method payment_method NOT NULL,
  transaction_ref TEXT UNIQUE,
  receipt_number TEXT,
  proof_url TEXT,
  processed_by UUID REFERENCES teachers(id),
  processed_at TIMESTAMPTZ DEFAULT NOW(),
  notes TEXT,
  created_at TIMESTAMPTZ DEFAULT NOW()
);

-- Enable RLS
ALTER TABLE fee_items ENABLE ROW LEVEL SECURITY;
ALTER TABLE fee_assignments ENABLE ROW LEVEL SECURITY;
ALTER TABLE invoices ENABLE ROW LEVEL SECURITY;
ALTER TABLE invoice_items ENABLE ROW LEVEL SECURITY;
ALTER TABLE payment_transactions ENABLE ROW LEVEL SECURITY;
```

### 5. Communications Tables

**File**: `supabase/migrations/20260122000005_communications_tables.sql`

```sql
-- Notifications
CREATE TABLE notifications (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  title TEXT NOT NULL,
  message TEXT NOT NULL,
  target_role user_role NOT NULL,
  target_grades TEXT[],
  target_classes TEXT[],
  type notification_type DEFAULT 'info',
  priority TEXT DEFAULT 'normal' CHECK (priority IN ('low', 'normal', 'high', 'urgent')),
  attachment_url TEXT,
  published_by UUID REFERENCES profiles(id),
  published_at TIMESTAMPTZ DEFAULT NOW(),
  scheduled_for TIMESTAMPTZ,
  expires_at TIMESTAMPTZ,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  CONSTRAINT scheduled_after_publish CHECK (scheduled_for IS NULL OR scheduled_for >= published_at)
);

-- Notification Reads
CREATE TABLE notification_reads (
  notification_id UUID NOT NULL REFERENCES notifications(id) ON DELETE CASCADE,
  user_id UUID NOT NULL REFERENCES profiles(id) ON DELETE CASCADE,
  read_at TIMESTAMPTZ DEFAULT NOW(),
  PRIMARY KEY (notification_id, user_id)
);

-- Conversations
CREATE TABLE conversations (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  teacher_id UUID NOT NULL REFERENCES teachers(id),
  parent_id UUID NOT NULL REFERENCES parents(id),
  student_id UUID REFERENCES students(id),
  subject TEXT,
  last_message_at TIMESTAMPTZ,
  last_message_preview TEXT,
  status TEXT DEFAULT 'active' CHECK (status IN ('active', 'archived', 'closed')),
  teacher_unread INT DEFAULT 0,
  parent_unread INT DEFAULT 0,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW(),
  UNIQUE(teacher_id, parent_id, student_id)
);

-- Messages
CREATE TABLE messages (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  conversation_id UUID NOT NULL REFERENCES conversations(id) ON DELETE CASCADE,
  sender_id UUID NOT NULL REFERENCES profiles(id),
  sender_role TEXT CHECK (sender_role IN ('teacher', 'parent')),
  content TEXT NOT NULL,
  attachment_url TEXT,
  is_deleted BOOLEAN DEFAULT false,
  read_at TIMESTAMPTZ,
  created_at TIMESTAMPTZ DEFAULT NOW()
);

-- Leave Requests
CREATE TABLE leave_requests (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  student_id UUID NOT NULL REFERENCES students(id) ON DELETE CASCADE,
  class_id TEXT NOT NULL REFERENCES classes(id) ON DELETE CASCADE,
  start_date DATE NOT NULL,
  end_date DATE NOT NULL,
  reason TEXT NOT NULL,
  status leave_status DEFAULT 'pending',
  submitted_by UUID REFERENCES parents(id),
  submitted_at TIMESTAMPTZ DEFAULT NOW(),
  reviewed_by UUID REFERENCES teachers(id),
  reviewed_at TIMESTAMPTZ,
  review_note TEXT,
  parent_contact TEXT,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW(),
  CONSTRAINT valid_date_range CHECK (end_date >= start_date)
);

-- Enable RLS
ALTER TABLE notifications ENABLE ROW LEVEL SECURITY;
ALTER TABLE notification_reads ENABLE ROW LEVEL SECURITY;
ALTER TABLE conversations ENABLE ROW LEVEL SECURITY;
ALTER TABLE messages ENABLE ROW LEVEL SECURITY;
ALTER TABLE leave_requests ENABLE ROW LEVEL SECURITY;
```

## TypeScript Types Generation

```bash
# Generate types from Supabase
npx supabase gen types typescript --local > packages/shared-types/src/supabase.types.ts

# Or for remote project
npx supabase gen types typescript --project-id YOUR_PROJECT_ID > packages/shared-types/src/supabase.types.ts
```

## Environment Variables

```env
# .env.local
NEXT_PUBLIC_SUPABASE_URL=your_supabase_url
NEXT_PUBLIC_SUPABASE_ANON_KEY=your_supabase_anon_key
SUPABASE_SERVICE_ROLE_KEY=your_service_role_key  # Server-side only
```

## Supabase Client Setup

**File**: `apps/web/lib/supabase/client.ts`

```typescript
import { createClient } from '@supabase/supabase-js'
import { Database } from '@/shared-types/supabase.types'

const supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL!
const supabaseAnonKey = process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!

export const supabase = createClient<Database>(supabaseUrl, supabaseAnonKey)

// Server client with service role
export const supabaseAdmin = createClient<Database>(
  supabaseUrl,
  process.env.SUPABASE_SERVICE_ROLE_KEY!,
  { auth: { persistSession: false } }
)
```

**File**: `apps/mobile/lib/supabase/client.ts`

```typescript
import { createClient } from '@supabase/supabase-js'
import { Database } from '@shared-types/supabase.types'

const supabaseUrl = process.env.EXPO_PUBLIC_SUPABASE_URL!
const supabaseAnonKey = process.env.EXPO_PUBLIC_SUPABASE_ANON_KEY!

export const supabase = createClient<Database>(supabaseUrl, supabaseAnonKey)
```

## Migration Commands

```bash
# Apply migrations locally
npx supabase db push

# Apply migrations to remote
npx supabase db push --remote

# Generate types after migration
npx supabase gen types typescript --local > packages/shared-types/src/supabase.types.ts

# Seed initial data
npx supabase db seed
```

## Seed Data

**File**: `supabase/seed.sql`

```sql
-- ============================================
-- IMPORTANT NOTES
-- ============================================
-- 1. Admin user: Create via Supabase dashboard or CLI (not in seed.sql)
-- 2. Teachers/Students/Parents: Created via web app (AddUserModal)
-- 3. Fee items: Added dynamically via admin panel (your custom function)
-- 4. This seed only contains static reference data
-- ============================================

-- Insert grades
INSERT INTO grades (id, name, display_order) VALUES
  ('6', 'Khối 6', 6),
  ('7', 'Khối 7', 7),
  ('8', 'Khối 8', 8),
  ('9', 'Khối 9', 9);

-- Insert subjects
INSERT INTO subjects (id, name, name_en, code, is_core, display_order) VALUES
  ('toan', 'Toán', 'Mathematics', 'M_TOAN', true, 1),
  ('van', 'Tiếng Việt', 'Vietnamese', 'M_VAN', true, 2),
  ('anh', 'Tiếng Anh', 'English', 'M_ANH', true, 3),
  ('ly', 'Vật lý', 'Physics', 'M_LY', false, 4),
  ('hoa', 'Hóa học', 'Chemistry', 'M_HOA', false, 5),
  ('sinh', 'Sinh học', 'Biology', 'M_SINH', false, 6),
  ('su', 'Lịch sử', 'History', 'M_SU', false, 7),
  ('dia', 'Địa lý', 'Geography', 'M_DIA', false, 8),
  ('gdcd', 'GDCD', 'Civic Education', 'M_GDCD', false, 9),
  ('td', 'Tiếng Trung', 'Chinese', 'M_TD', false, 10),
  ('tin', 'Tin học', 'IT', 'M_TIN', false, 11),
  ('th', 'Thể dục', 'PE', 'M_TH', false, 12),
  ('anhvan', 'Tiếng Anh (bổ sung)', 'English Extra', 'M_ANHVAN', false, 13);

-- Insert periods
INSERT INTO periods (id, name, start_time, end_time, is_break, display_order) VALUES
  (1, 'Tiết 1', '07:30:00', '08:15:00', false, 1),
  (2, 'Tiết 2', '08:20:00', '09:05:00', false, 2),
  (3, 'Tiết 3', '09:15:00', '10:00:00', false, 3),
  (4, 'Tiết 4', '10:10:00', '10:55:00', false, 4),
  (5, 'Tiết 5', '11:00:00', '11:45:00', false, 5),
  (6, 'Tiết 6', '14:00:00', '14:45:00', false, 6),
  (7, 'Tiết 7', '14:50:00', '15:35:00', false, 7),
  (8, 'Tiết 8', '15:40:00', '16:25:00', false, 8),
  (9, 'Tiết 9', '16:30:00', '17:15:00', false, 9),
  (10, 'Tiết 10', '17:20:00', '18:05:00', false, 10);
```

## Admin User Creation

After running migrations, create the initial admin user:

### Option 1: Via Supabase Dashboard
1. Go to Supabase dashboard → Authentication → Users
2. Click "Add user" → "Create new user"
3. Enter email: `admin@school.edu`
4. Set a secure password
5. Click "Auto Confirm User" to skip email verification
6. The `handle_new_user()` trigger will auto-create the profile with `role='admin'`

### Option 2: Via Supabase CLI
```bash
# Create admin user in auth
npx supabase auth admin create \
  --email admin@school.edu \
  --password YOUR_SECURE_PASSWORD \
  --email-confirm

# Or create directly in SQL
INSERT INTO profiles (id, email, role, full_name, status)
VALUES (
  gen_random_uuid(),
  'admin@school.edu',
  'admin',
  'Admin User',
  'active'
);
```

### User Creation via App

**Teachers, Students, and Parents** are created through the web app:
- Navigate to: `/admin/users`
- Click "Thêm người dùng" (Add User)
- Fill in the form (see Phase 01 for field details)
- The app will:
  1. Create auth user via Supabase Auth
  2. Auto-create profile via trigger
  3. Insert into role-specific table (students/teachers/parents)
  4. Generate auto codes (HS20260001, GV20260001, PH20260001)

## Requirements Met

- [x] Complete migration scripts
- [x] RLS policies included
- [x] TypeScript types generation
- [x] Supabase client setup
- [x] Seed data for initial deployment

## Success Criteria

All migrations run successfully with:
```bash
npx supabase db push
npx supabase gen types typescript --local
```
