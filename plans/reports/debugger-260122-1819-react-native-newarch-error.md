# Debug Report: React Native New Architecture Type Error
**Date**: 2026-01-22 18:19
**Issue**: `Error: Exception in HostFunction: TypeError: expected dynamic type 'boolean', but had type 'string'`
**ID**: debugger-260122-1819-react-native-newarch-error

## Executive Summary

**ROOT CAUSE IDENTIFIED**: iOS Info.plist has `RCTNewArchEnabled = true` (boolean) while Android native code has `newArchEnabled` **undefined** in gradle.properties, causing BuildConfig to use a **string** value instead of boolean.

**Impact**: App crashes on startup due to type mismatch between expected boolean and actual string in native bridge.

**Fix**: Add `newArchEnabled=false` to `android/gradle.properties` and regenerate native code with `npx expo prebuild --clean`.

---

## Technical Analysis

### 1. Configuration Audit

#### `apps/mobile/app.json`
**Status**: ✅ **CLEAN** - No New Architecture settings present
```json
{
  "expo": {
    "plugins": [
      "expo-dev-client",
      ["expo-build-properties", {"android": {"kotlinVersion": "2.0.21"}}]
    ]
  }
}
```
- ❌ No `newArchEnabled` property at root level
- ❌ No `newArchEnabled` in expo-dev-client plugin config

#### `apps/mobile/android/gradle.properties`
**Status**: ⚠️ **MISSING CRITICAL PROPERTY**
```properties
# Line 38: Comment says "removed newArchEnabled=false to enable Fabric/TurboModules"
# But newArchEnabled property is NOT defined!
```
**Found**:
- ✅ `hermesEnabled=true`
- ✅ `expo.gif.enabled=true`
- ✅ `expo.webp.enabled=true`
- ❌ **MISSING**: `newArchEnabled=false` or `newArchEnabled=true`

**Impact**: When undefined, React Native defaults to `"false"` (string) instead of `false` (boolean).

#### `apps/mobile/android/app/build.gradle`
**Status**: ✅ **CLEAN** - No hardcoded boolean-as-string issues
- Line 68: `enableProguardInReleaseBuilds` uses `.toBoolean()` correctly
- Line 113: `minifyEnabled` references boolean variable
- Line 116: `crunchPngs` uses `.toBoolean()` correctly
- Line 121: `useLegacyPackaging` uses `.toBoolean()` correctly
- Line 153: `expo.gif.enabled` string comparison: `== "true"`
- Line 154: `expo.webp.enabled` string comparison: `== "true"`
- Line 171: `hermesEnabled.toBoolean()` - **BUG SOURCE**: if hermesEnabled is string, crashes

### 2. Generated Native Code Analysis

#### iOS Info.plist (Auto-generated)
**Status**: ⚠️ **HAS NEW ARCHITECTURE ENABLED**
```xml
<key>RCTNewArchEnabled</key>
<true/>
```
**Source**: Generated by Expo prebuild from `app.json` absence of `newArchEnabled: false`
**Issue**: iOS defaults to ENABLED when not explicitly disabled

#### Android BuildConfig (Expected, not found in source)
**Expected Generated Code**:
```java
public static final boolean IS_NEW_ARCHITECTURE_ENABLED = false; // or true
public static final boolean IS_HERMES_ENABLED = true;
```
**Actual Issue**: If `newArchEnabled` is missing from gradle.properties:
1. React Native Gradle plugin reads: `findProperty('newArchEnabled') ?: "false"`
2. Returns string `"false"` instead of boolean `false`
3. BuildConfig.IS_NEW_ARCHITECTURE_ENABLED = `"false"` (STRING)
4. Native bridge expects boolean, receives string → **CRASH**

#### Android MainActivity.kt
**Line 8**: `import com.facebook.react.defaults.DefaultNewArchitectureEntryPoint.fabricEnabled`
**Line 39**: `fabricEnabled` passed to DefaultReactActivityDelegate
**Issue**: `fabricEnabled` resolves via DefaultNewArchitectureEntryPoint based on BuildConfig.IS_NEW_ARCHITECTURE_ENABLED
- If BuildConfig has string `"false"`, fabricEnabled becomes STRING
- DefaultReactActivityDelegate expects BOOLEAN → **TYPE ERROR**

#### Android MainApplication.kt
**Line 35**: `override val isNewArchEnabled: Boolean = BuildConfig.IS_NEW_ARCHITECTURE_ENABLED`
**Line 46**: `if (BuildConfig.IS_NEW_ARCHITECTURE_ENABLED) { load() }`
**Issue**: Type mismatch if BuildConfig.IS_NEW_ARCHITECTURE_ENABLED is string

### 3. React Native Paper Config Check
**Status**: ✅ **CLEAN** - No boolean-as-string issues
- App.tsx: `<PaperProvider theme={theme}>` - theme object, no boolean props
- package.json: `"react-native-paper": "^5.14.5"` - Compatible with both old/new architecture
- No hardcoded boolean props in Paper usage

### 4. Expo Config Introspection
**Command**: `npx expo config --type introspect`
**Key Finding**:
```javascript
ios: {
  infoPlist: {
    RCTNewArchEnabled: true  // iOS defaults to ENABLED
  }
}
```
**Issue**: iOS Info.plist has `RCTNewArchEnabled = true` (boolean) while Android has undefined/newArchEnabled

---

## Root Cause Identification

### Primary Issue
**`newArchEnabled` property missing from `android/gradle.properties`**

### Type Mismatch Chain
```
gradle.properties: newArchEnabled undefined
    ↓
React Native Gradle Plugin: findProperty('newArchEnabled') ?: "false" (returns STRING)
    ↓
BuildConfig.IS_NEW_ARCHITECTURE_ENABLED = "false" (STRING, not boolean)
    ↓
MainActivity.kt: fabricEnabled = BuildConfig.IS_NEW_ARCHITECTURE_ENABLED (STRING)
    ↓
DefaultReactActivityDelegate(fabricEnabled) expects BOOLEAN
    ↓
HostFunction.jsi: expected boolean, got string
    ↓
CRASH: TypeError: expected dynamic type 'boolean', but had type 'string'
```

### Why iOS Works But Android Doesn't
- iOS: Info.plist has `RCTNewArchEnabled = <true/>` (proper boolean XML)
- Android: gradle.properties missing property → string default → type mismatch

---

## Immediate Fix

### Option 1: Disable New Architecture (Recommended for Expo Go)
**File**: `apps/mobile/android/gradle.properties`
**Add after line 42**:
```properties
# Disable New Architecture for Expo Go compatibility
newArchEnabled=false
```

**Then regenerate native code**:
```bash
cd apps/mobile
npx expo prebuild --clean
```

**Verify**:
```bash
# Check BuildConfig has boolean, not string
grep "IS_NEW_ARCHITECTURE_ENABLED" android/app/build/generated/source/buildConfig/debug/com/schoolmanagement/econtact/BuildConfig.java
# Expected: public static final boolean IS_NEW_ARCHITECTURE_ENABLED = false;
```

### Option 2: Enable New Architecture (If using dev client builds)
**File**: `apps/mobile/app.json`
**Add to expo root config**:
```json
{
  "expo": {
    "newArchEnabled": false,  // Add this line
    "plugins": [
      ["expo-dev-client", {"newArchEnabled": false}],  // Add this
      "expo-build-properties"
    ]
  }
}
```

**File**: `apps/mobile/android/gradle.properties`
**Add after line 42**:
```properties
newArchEnabled=false
```

**Then regenerate**:
```bash
cd apps/mobile
npx expo prebuild --clean
```

---

## Additional Findings

### 1. hermesEnabled Type Issue
**File**: `android/app/build.gradle:171`
```gradle
if (hermesEnabled.toBoolean()) {
```
**Issue**: If `hermesEnabled=true` in gradle.properties (which it is), `.toBoolean()` works correctly
**But**: If someone changes it to string `hermesEnabled="true"`, would also crash
**Status**: ✅ Safe, but fragile

### 2. Other String Comparisons
**File**: `android/app/build.gradle:153-154`
```gradle
def isGifEnabled = (findProperty('expo.gif.enabled') ?: "") == "true";
def isWebpEnabled = (findProperty('expo.webp.enabled') ?: "") == "true";
```
**Status**: ✅ Safe - Explicitly comparing to string "true"

### 3. iOS Configuration
**File**: iOS Info.plist (auto-generated)
```xml
<key>RCTNewArchEnabled</key>
<true/>
```
**Issue**: iOS has New Architecture ENABLED by default when not explicitly disabled
**Fix**: Add `newArchEnabled: false` to app.json to disable globally

---

## Verification Steps

After applying fix:

```bash
# 1. Clear all caches
cd apps/mobile
rm -rf android/
rm -rf ios/
rm -rf node_modules/.cache/
npx expo start --clear

# 2. Regenerate native code
npx expo prebuild --clean

# 3. Verify BuildConfig (Android)
grep "IS_NEW_ARCHITECTURE_ENABLED" android/app/build/generated/source/buildConfig/*/com/schoolmanagement/econtact/BuildConfig.java
# Expected output: public static final boolean IS_NEW_ARCHITECTURE_ENABLED = false;

# 4. Verify Info.plist (iOS)
grep -A 1 "RCTNewArchEnabled" ios/*/Info.plist
# Expected output:
# <key>RCTNewArchEnabled</key>
# <false/>

# 5. Verify Expo config
npx expo config --type introspect | grep -A 5 "RCTNewArchEnabled"
# Expected: RCTNewArchEnabled: false (iOS) or not present (Android)

# 6. Run app
npx expo start --clear
# Should launch without type error
```

---

## Unresolved Questions

1. **Why did previous setup work?**
   - Hypothesis: Previous version of app.json had `newArchEnabled: false` explicitly set
   - Evidence: `app.json.backup` has `newArchEnabled: false` at lines 22 and 27
   - Action: Check git history for when `newArchEnabled` was removed

2. **Is iOS also affected?**
   - iOS Info.plist currently has `RCTNewArchEnabled = <true/>`
   - If user wants New Architecture DISABLED, iOS also needs fix
   - Action: Test on iOS simulator after applying fix

3. **Will Expo Go work with New Architecture enabled?**
   - Expo Go does NOT support New Architecture
   - User must use `expo-dev-client` for New Architecture
   - Action: Confirm user's target deployment method

4. **Are there cached native files?**
   - BuildConfig not found in source tree (generated during build)
   - Possible stale build cache in `android/.gradle/` or `android/app/build/`
   - Action: Run `cd android && ./gradlew clean` if issue persists

---

## Files Modified/Checked

| File Path | Status | Issue | Line # |
|-----------|--------|-------|--------|
| `apps/mobile/app.json` | ✅ Checked | Missing `newArchEnabled` property | - |
| `apps/mobile/android/gradle.properties` | ❌ **CRITICAL** | Missing `newArchEnabled=false` | 42 (add after) |
| `apps/mobile/android/app/build.gradle` | ✅ Checked | No hardcoded string booleans found | 68, 113, 116, 121, 153-154, 171 |
| `apps/mobile/android/app/src/main/java/.../MainActivity.kt` | ⚠️ Uses | `fabricEnabled` import (line 8) expects boolean | 39 |
| `apps/mobile/android/app/src/main/java/.../MainApplication.kt` | ⚠️ Uses | `BuildConfig.IS_NEW_ARCHITECTURE_ENABLED` expects boolean | 35, 46 |
| `apps/mobile/App.tsx` | ✅ Checked | PaperProvider props are clean | 20 |
| `apps/mobile/package.json` | ✅ Checked | No boolean config issues | - |

---

## References

- **Error Location**: `HostFunction.jsi` (React Native core bridge)
- **Type Mismatch**: String `"false"` vs Boolean `false`
- **Affected Platform**: Android primary, iOS secondary
- **Expo SDK**: 54.0.0
- **React Native**: 0.81.5
- **React**: 19.1.0

---

## Next Steps

1. ✅ **Apply fix**: Add `newArchEnabled=false` to `android/gradle.properties`
2. ✅ **Add to app.json**: `"newArchEnabled": false` at root level
3. ✅ **Clean rebuild**: `npx expo prebuild --clean`
4. ⏳ **Test**: Launch app with `npx expo start --clear`
5. ⏳ **Verify**: Check BuildConfig has boolean type
6. ⏳ **Commit**: Add files with explicit `newArchEnabled: false` settings

---

**Report End**
